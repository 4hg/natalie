#!/usr/bin/env ruby

require 'optparse'
require 'tempfile'
require_relative '../lib/natalie'

options = {}
OptionParser.new do |opts|
  opts.banner = "Usage: natalie [options] file.nat"

  opts.on("-d", "--debug", "Show debug output") do |d|
    options[:debug] = d
  end

  opts.on("-e one-line-script", "Execute one-line script") do |e|
    options[:execute] = e
  end

  opts.on("--ast", "Show AST rather than compiling") do |ast|
    options[:ast] = ast
  end
end.parse!

if options[:execute]
  source_path = "immediate"
  code = options[:execute].gsub(/\\n/, "\n")
else
  source_path = ARGV.shift
  code = File.read(source_path)
end

parser = Natalie::Parser.new(code)
ast = parser.ast

if options[:ast]
  require 'pp'
  pp ast
else
  compiler = Natalie::Compiler.new(ast)
  out = Tempfile.create('natalie')
  compiler.compile(out)
  puts `#{out}`
end